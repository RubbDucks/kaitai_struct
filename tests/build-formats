#!/bin/sh -e

SCRIPT_DIR="$(CDPATH= cd -- "$(dirname "$0")" && pwd)"
. "$SCRIPT_DIR/config"

TARGET="${1:-all}"
EXCLUSIONS_FILE="$SCRIPT_DIR/migration_golden/build_formats_exclusions.tsv"

if [ "$TARGET" = all ]; then
    OUTPUT_DIR="$FORMATS_COMPILED_DIR"
else
    OUTPUT_DIR="$FORMATS_COMPILED_DIR/$TARGET"
fi

rm -rf "$OUTPUT_DIR"
mkdir -p "$OUTPUT_DIR"

GENERATED_COUNT=0
FAILED_COUNT=0
SKIPPED_COUNT=0
FAILURES_TMP="$(mktemp)"
SKIPPED_TMP="$(mktemp)"
SUMMARY_PATH_DEFAULT="$OUTPUT_DIR/build-formats-summary.json"
SUMMARY_PATH="${BUILD_FORMATS_SUMMARY_PATH:-$SUMMARY_PATH_DEFAULT}"

cleanup() {
    rm -f "$FAILURES_TMP" "$SKIPPED_TMP"
}
trap cleanup EXIT

is_excluded() {
    engine="$1"
    target="$2"
    variant="$3"
    ksy="$4"
    if [ ! -f "$EXCLUSIONS_FILE" ]; then
        return 1
    fi
    awk -F '\t' -v e="$engine" -v t="$target" -v v="$variant" -v k="$ksy" '
        BEGIN { matched=0 }
        /^#/ || NF < 5 { next }
        $1 == e && $2 == t && $3 == v && $4 == k { matched=1 }
        END { exit matched ? 0 : 1 }
    ' "$EXCLUSIONS_FILE"
}

exclusion_reason() {
    engine="$1"
    target="$2"
    variant="$3"
    ksy="$4"
    awk -F '\t' -v e="$engine" -v t="$target" -v v="$variant" -v k="$ksy" '
        /^#/ || NF < 5 { next }
        $1 == e && $2 == t && $3 == v && $4 == k { print $5; exit 0 }
    ' "$EXCLUSIONS_FILE"
}

run_compile() {
    engine="$1"
    target="$2"
    variant="$3"
    ksy="$4"
    shift 4

    if "$@"; then
        GENERATED_COUNT=$((GENERATED_COUNT + 1))
        return 0
    fi

    if is_excluded "$engine" "$target" "$variant" "$ksy"; then
        reason="$(exclusion_reason "$engine" "$target" "$variant" "$ksy")"
        SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        printf '%s\t%s\t%s\t%s\n' "$variant" "$ksy" "${reason:-excluded}" "$engine" >> "$SKIPPED_TMP"
        echo "[build-formats] excluded failure engine=$engine target=$target variant=$variant ksy=$ksy reason=${reason:-excluded}" >&2
        return 0
    fi

    FAILED_COUNT=$((FAILED_COUNT + 1))
    printf '%s\t%s\n' "$variant" "$ksy" >> "$FAILURES_TMP"
    echo "[build-formats] unexpected failure engine=$engine target=$target variant=$variant ksy=$ksy" >&2
    return 0
}

emit_python_skip_stub() {
    stub_path="$1"
    ksy="$2"
    variant="$3"

    stub_dir="$(dirname "$stub_path")"
    mkdir -p "$stub_dir"
    cat > "$stub_path" <<EOF
# Auto-generated placeholder for cpp17 migration gap.
import unittest

raise unittest.SkipTest("cpp17 migration gap: skipped ${variant} generation for ${ksy}")
EOF
}

emit_summary() {
    unexpected="$FAILED_COUNT"
    {
        printf '{\n'
        printf '  "engine": "%s",\n' "$KAITAI_COMPILER_ENGINE"
        printf '  "target": "%s",\n' "$TARGET"
        printf '  "generated": %s,\n' "$GENERATED_COUNT"
        printf '  "failed": %s,\n' "$FAILED_COUNT"
        printf '  "skipped": %s,\n' "$SKIPPED_COUNT"
        printf '  "status": "%s"\n' "$( [ "$unexpected" -eq 0 ] && echo success || echo failed )"
        printf '}\n'
    } > "$SUMMARY_PATH"

    echo "[build-formats-summary] engine=$KAITAI_COMPILER_ENGINE target=$TARGET generated=$GENERATED_COUNT failed=$FAILED_COUNT skipped=$SKIPPED_COUNT summary=$SUMMARY_PATH" >&2
    if [ "$SKIPPED_COUNT" -gt 0 ]; then
        echo "[build-formats-summary] skipped entries:" >&2
        awk -F '\t' '{ printf "  - variant=%s ksy=%s reason=%s engine=%s\n", $1, $2, $3, $4 }' "$SKIPPED_TMP" >&2
    fi
    if [ "$FAILED_COUNT" -gt 0 ]; then
        echo "[build-formats-summary] unexpected failures:" >&2
        awk -F '\t' '{ printf "  - variant=%s ksy=%s\n", $1, $2 }' "$FAILURES_TMP" >&2
    fi

    [ "$FAILED_COUNT" -eq 0 ]
}

if [ "$KAITAI_COMPILER_ENGINE" = "scala" ]; then
    echo "[compiler-engine] selected=scala script=build-formats target=$TARGET" >&2

    # 	--java-from-file-class io.kaitai.struct.RandomAccessFileKaitaiStream \

    for ksy_path in "$FORMATS_KSY_DIR"/*.ksy; do
        ksy="$(basename "$ksy_path")"
        run_compile "scala" "$TARGET" "default" "$ksy" \
            "$SCALA_COMPILER_BIN" -- \
            --verbose file -t "$TARGET" -d "$OUTPUT_DIR" \
            --import-path "$FORMATS_REPO_DIR" \
            --import-path "$FORMATS_KSY_DIR/ks_path" \
            --java-package io.kaitai.struct.testformats \
            --php-namespace 'Kaitai\Struct\Tests' \
            --python-package testformats \
            --go-package test_formats \
            --nim-module "kaitai_struct_nim_runtime" \
            --nim-opaque "../../tests/spec/nim/opaque/" \
            "$ksy_path"
    done

    if [ "$TARGET" = java ] || [ "$TARGET" = all ]; then
	for ksy_path in "$FORMATS_KSY_DIR"/*.ksy; do
	    ksy="$(basename "$ksy_path")"
	    run_compile "scala" "$TARGET" "java_read_write" "$ksy" \
	        "$SCALA_COMPILER_BIN" -- \
		    --verbose file -t java -d "$FORMATS_COMPILED_DIR/java/src" \
		    --no-auto-read \
		    --read-write \
		    --import-path "$FORMATS_REPO_DIR" \
		    --import-path "$FORMATS_KSY_DIR/ks_path" \
		    --java-package io.kaitai.struct.testwrite \
		    "$ksy_path"
	done
    fi

    if [ "$TARGET" = python ] || [ "$TARGET" = all ]; then
	    rm -rf "$FORMATS_COMPILED_DIR/python/testformats" "$FORMATS_COMPILED_DIR/python-tmp"
	    if [ -d "$FORMATS_COMPILED_DIR/python" ]; then
	        mv "$FORMATS_COMPILED_DIR/python" "$FORMATS_COMPILED_DIR/python-tmp"
	    fi
	    mkdir -p "$FORMATS_COMPILED_DIR/python"
	    if [ -d "$FORMATS_COMPILED_DIR/python-tmp" ]; then
	        mv "$FORMATS_COMPILED_DIR/python-tmp" "$FORMATS_COMPILED_DIR/python/testformats"
	    else
	        mkdir -p "$FORMATS_COMPILED_DIR/python/testformats"
	    fi
     	# __init__.py is needed in Python 2
     	touch "$FORMATS_COMPILED_DIR/python/testformats/__init__.py"

	for ksy_path in "$FORMATS_KSY_DIR"/*.ksy; do
	    ksy="$(basename "$ksy_path")"
	    run_compile "scala" "$TARGET" "python_testwrite" "$ksy" \
	        "$SCALA_COMPILER_BIN" -- \
		    --verbose file -t python -d "$FORMATS_COMPILED_DIR/python/testwrite" \
		    --no-auto-read \
		    --read-write \
		    --import-path "$FORMATS_REPO_DIR" \
		    --import-path "$FORMATS_KSY_DIR/ks_path" \
		    --python-package testwrite \
		    "$ksy_path"
	done

    	# __init__.py is needed in Python 2
    	touch "$FORMATS_COMPILED_DIR/python/testwrite/__init__.py"
    fi
elif [ "$KAITAI_COMPILER_ENGINE" = "cpp17" ]; then
    echo "[compiler-engine] selected=cpp17 script=build-formats target=$TARGET" >&2

    case "$TARGET" in
        cpp_stl|lua|wireshark_lua|python|ruby)
            ;;
        *)
            echo "build-formats: cpp17 engine currently supports only targets=cpp_stl,lua,wireshark_lua,python,ruby (got: $TARGET); use KAITAI_COMPILER_ENGINE=scala for other targets" >&2
            exit 2
            ;;
    esac

    if [ ! -x "$CPP17_COMPILER_BIN" ]; then
        echo "build-formats: C++17 compiler missing at $CPP17_COMPILER_BIN; run cmake -S compiler-cpp -B compiler-cpp/build && cmake --build compiler-cpp/build" >&2
        exit 2
    fi

    if [ "$TARGET" = python ]; then
        mkdir -p "$OUTPUT_DIR/testformats" "$OUTPUT_DIR/testwrite"
        touch "$OUTPUT_DIR/testformats/__init__.py"
        touch "$OUTPUT_DIR/testwrite/__init__.py"

        for ksy_path in "$FORMATS_KSY_DIR"/*.ksy; do
            ksy="$(basename "$ksy_path")"
            run_compile "cpp17" "$TARGET" "default" "$ksy" \
                "$CPP17_COMPILER_BIN" --verbose file -t "$TARGET" --cpp-standard 17 \
                -d "$OUTPUT_DIR" \
                --python-package testformats \
                --import-path "$FORMATS_REPO_DIR" \
                --import-path "$FORMATS_KSY_DIR/ks_path" \
                "$ksy_path"
        done

        for ksy_path in "$FORMATS_KSY_DIR"/*.ksy; do
            ksy="$(basename "$ksy_path")"
            module_name="${ksy%.ksy}.py"
            if [ ! -f "$OUTPUT_DIR/testformats/$module_name" ]; then
                emit_python_skip_stub "$OUTPUT_DIR/testformats/$module_name" "$ksy" "default"
            fi
            emit_python_skip_stub "$OUTPUT_DIR/testwrite/$module_name" "$ksy" "python_testwrite"
        done
    else
        for ksy_path in "$FORMATS_KSY_DIR"/*.ksy; do
            ksy="$(basename "$ksy_path")"
            run_compile "cpp17" "$TARGET" "default" "$ksy" \
                "$CPP17_COMPILER_BIN" --verbose file -t "$TARGET" --cpp-standard 17 \
                -d "$OUTPUT_DIR" \
                --import-path "$FORMATS_REPO_DIR" \
                --import-path "$FORMATS_KSY_DIR/ks_path" \
                "$ksy_path"
        done
    fi
else
    echo "Unknown KAITAI_COMPILER_ENGINE='$KAITAI_COMPILER_ENGINE' (supported: scala, cpp17)" >&2
    exit 2
fi

emit_summary
